<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Viewer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/umd/date-fns.min.js"></script>
    <style>
        pre {
            white-space: pre-wrap; /* Enable word wrap */
            word-wrap: break-word; /* Break long words */
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <h1 class="text-center">Log Viewer</h1>
        <div class="row mt-4">
            <div class="col-2 border">
                <h5 class="text-center">Log Lines</h5>
                <div class="d-flex justify-content-between mb-2">
                    <button id="sort-asc" class="btn btn-sm btn-primary">Sort Ascending</button>
                    <button id="sort-desc" class="btn btn-sm btn-secondary">Sort Descending</button>
                </div>
                <ul id="log-lines" class="list-group">
                    <!-- Log lines will be dynamically added here -->
                </ul>
            </div>
            <div class="col-5 border">
                <h5 class="text-center">Request</h5>
                <pre id="request-message" class="p-2 bg-light rounded language-json"><code></code></pre>
            </div>
            <div class="col-5 border">
                <h5 class="text-center">Response</h5>
                <pre id="response-message" class="p-2 bg-light rounded language-json"><code></code></pre>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const logLinesElement = document.getElementById('log-lines');
            const requestMessageElement = document.querySelector('#request-message code');
            const responseMessageElement = document.querySelector('#response-message code');
            const sortAscButton = document.getElementById('sort-asc');
            const sortDescButton = document.getElementById('sort-desc');

            let logs = [];

            const renderLogs = (sortedLogs) => {
                logLinesElement.innerHTML = '';
                sortedLogs.forEach((log) => {
                    const listItem = document.createElement('li');
                    listItem.className = 'list-group-item';
                    const time = log.timestamp || 'No Time';
                    listItem.textContent = time;
                    listItem.addEventListener('click', () => {
                        const message = log.message || {};
                        requestMessageElement.textContent = message.Request ? JSON.stringify(message.Request, null, 2) : 'No Request Data';
                        responseMessageElement.textContent = message.Response ? JSON.stringify(message.Response, null, 2) : 'No Response Data';
                        Prism.highlightElement(requestMessageElement);
                        Prism.highlightElement(responseMessageElement);
                    });
                    logLinesElement.appendChild(listItem);
                });
            };

            try {
                const response = await fetch('/logs');
                logs = await response.json();

                // Default sort in descending order
                logs.sort((a, b) => {
                    const parseTime = (time) => {
                        if (!time) return null;
                        const parsedTime = new Date(time);
                        return isNaN(parsedTime) ? null : parsedTime;
                    };

                    const timeA = parseTime(a.timestamp);
                    const timeB = parseTime(b.timestamp);

                    return timeB - timeA;
                });
                renderLogs(logs);

                sortAscButton.addEventListener('click', () => {
                    const sortedLogs = [...logs].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    renderLogs(sortedLogs);
                });

                sortDescButton.addEventListener('click', () => {
                    const sortedLogs = [...logs].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    renderLogs(sortedLogs);
                });
            } catch (error) {
                console.error('Error fetching logs:', error);
            }
        });
    </script>
</body>
</html>
